#+PROPERTY: header-args :tangle "init.el"
#+STARTUP: content indent
* Startup performance optimization
:PROPERTIES:
:ID:       422c3f0a-c9ef-4925-851e-26dc45a42031
:END:
#+BEGIN_SRC emacs-lisp
;; -*- lexical-binding: t; -*-
;; Restore reasonable GC settings after startup
(add-hook 'emacs-startup-hook
          (lambda ()
            (setq gc-cons-threshold (* 2 1000 1000)) ;; 2MB
            (setq gc-cons-percentage 0.1)

            ;; Show startup time
            (message "Emacs loaded in %s with %d garbage collections."
                     (format "%.2f seconds"
                             (float-time (time-subtract after-init-time before-init-time)))
                     gcs-done)))
#+END_SRC
* Package Management Setup
:PROPERTIES:
:ID:       a5e47f47-f913-4f75-a9bd-365b2d5b8f77
:END:
#+BEGIN_SRC emacs-lisp
  ;;;Bootstrap straight.el

(defvar bootstrap-version)
(let ((bootstrap-file
       (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
      (bootstrap-version 6))
  (unless (file-exists-p bootstrap-file)
    (with-current-buffer
        (url-retrieve-synchronously
         "https://raw.githubusercontent.com/radian-software/straight.el/develop/install.el"
         'silent 'inhibit-cookies)
      (goto-char (point-max))
      (eval-print-last-sexp)))
  (load bootstrap-file nil 'nomessage))

;; Configure use-package to use straight.el by default

(straight-use-package 'use-package)
(setq straight-use-package-by-default t)

;; add project and flymake to the pseudo-packages variable so straight.el doesn't download a separate version than what eglot downloads.
(setq straight-built-in-pseudo-packages '(emacs nadvice eglot python image-mode project flymake org org-element org-loaddefs))

;; stop warnings when installing packages

(add-to-list 'display-buffer-alist
             '("\\`\\*\\(Warnings\\|Compile-Log\\)\\*\\'"
               (display-buffer-no-window)
               (allow-no-window . t)))
#+END_SRC

* Core System Settings
:PROPERTIES:
:ID:       a9de239f-da0f-47fb-8f6d-a97306f8289a
:END:
#+BEGIN_SRC emacs-lisp
;;;Core System Settings

;; use zshell
(use-package exec-path-from-shell
  :config
  (setq exec-path-from-shell-shell-name "/usr/bin/zsh")
  (when (daemonp)
    (exec-path-from-shell-initialize)))

;; Use zsh for shell commands
(setq shell-file-name "/usr/bin/zsh")
(setq explicit-shell-file-name "/usr/bin/zsh")

;; make terminals read only after input so to not overwrite previous commands/output
(setq comint-prompt-read-only t)
(defun my-comint-preoutput-turn-buffer-read-only (text)
  (propertize text 'read-only t))
(add-hook 'comint-preoutput-filter-functions 'my-comint-preoutput-turn-buffer-read-only)

;; ansi colors in terminals and such
(use-package ansi-color
  :straight nil
  :config
  ;; For compilation/shell command buffers
  (add-hook 'compilation-filter-hook 'ansi-color-compilation-filter)

  ;; Also handle colors in shell-mode if you use M-x shell
  (add-hook 'shell-mode-hook 'ansi-color-for-comint-mode-on))

;; Make shell command output buffers easier to read
(with-eval-after-load 'compile
  ;; Automatically scroll to show new output
  (setq compilation-scroll-output t)

  ;; Don't ask to kill the buffer when running new command
  (setq compilation-always-kill t))

(setq use-short-answers t)

(setq confirm-kill-emacs 'yes-or-no-p)

;; Keep the directory clean
(use-package no-littering
  :config
  (setq auto-save-file-name-transforms
        `((".*" ,(no-littering-expand-var-file-name "auto-save/") t))))

;; Better help system
(use-package helpful
  :bind
  ([remap describe-function] . helpful-function)
  ([remap describe-variable] . helpful-variable)
  ([remap describe-key] . helpful-key))

;; Garbage collection magic hack for better performance
(use-package gcmh
  :init (gcmh-mode 1)
  :config
  (setq gcmh-idle-delay 5
        gcmh-high-cons-threshold (* 16 1024 1024))) ;; 16MB

(electric-pair-mode 1)

(use-package ews
  :straight nil
  :load-path "~/.config/emacs/lisp")
#+END_SRC

* UI Configuration
:PROPERTIES:
:ID:       3d5ac9fc-6f1a-4efe-ab68-a17a8f505b5e
:END:
#+BEGIN_SRC emacs-lisp
  ;;; Core UI Configuration

;; Basic UI settings
(column-number-mode 1)
(global-display-line-numbers-mode 1)
(setq display-line-numbers-type 'relative) ;; Vim-like relative line numbers

;;line highlighting
;;enable it for all programming major modes
(add-hook 'prog-mode-hook #'hl-line-mode)
;;and for all modes derived from text-mode
(add-hook 'text-mode-hook #'hl-line-mode)


;; disable line numbers in certain modes
(dolist (mode '(org-mode-hook
    		term-mode-hook
    		vterm-mode-hook
    		R-mode-hook
  		inferior-python-mode
    		eshell-mode-hook
    		eww-mode-hook))
  (add-hook mode (lambda () (display-line-numbers-mode 0))))

(setq visible-bell t            ; flash the bell rings
      use-dialog-box nil)       ; no dialog boxes
#+END_SRC
** Window Management
:PROPERTIES:
:ID:       f12fff77-0088-46b5-ab30-809b47d48666
:END:
#+BEGIN_SRC emacs-lisp
;; Split windows sensibly

(setq split-width-threshold 120
      split-height-threshold nil)

;(use-package balanced-windows
;  :config
;  (balanced-windows-mode 1))

(use-package popper
  :straight t
  :bind (("C-`"   . popper-toggle)
         ("M-`"   . popper-cycle)
         ("C-M-`" . popper-toggle-type))
  :init
  (setq popper-reference-buffers
        '("\\*Messages\\*"
	  "\\*eshell\\*"
	  "\\*vterm\\*"
          "Output\\*$"
          "\\*Async Shell Command\\*"
	  "\\*python:main\\*"
          help-mode
	  helpful-mode
          compilation-mode))
  (popper-mode +1)
  (popper-echo-mode +1))                ; For echo area hints
#+END_SRC
** Themes and Looks
:PROPERTIES:
:ID:       53c9b1e1-1781-426c-9fef-703e7ac21354
:END:
#+BEGIN_SRC emacs-lisp
(use-package modus-themes
  :config
  (mapc #'disable-theme custom-enabled-themes)
  (setq modus-themes-italic-constructs t
   	modus-themes-bold-constructs t)
  (modus-themes-include-derivatives-mode 1)

  (define-key global-map (kbd "<f5>") #'modus-themes-toggle))

(use-package ef-themes
  :config
  (setq ef-themes-to-toggle '(ef-day ef-owl))
  (load-theme 'ef-day :no-confirm-loading))

(use-package doric-themes
  :defer t)

(use-package theme-buffet
  :after (modus-themes ef-themes doric-themes)
  :config
  (require 'cal-dst)
  
  ;; Auto-adjust for DST
  (setopt theme-buffet-time-offset
          (1+ (/ (cadr (calendar-current-time-zone)) 60)))
  
  ;; Custom theme schedule (6 periods = 4 hours each)
  ;; Adjust the number of periods to change the division
  (setopt theme-buffet-end-user
          '(:night     (modus-vivendi ef-dark ef-autumn ef-night ef-duo-dark ef-symbiosis)
            :dawn      (ef-frost ef-winter)
            :morning   (modus-operandi ef-light ef-cyprus ef-spring ef-duo-light)
            :afternoon (modus-operandi-tinted ef-arbutus ef-day ef-kassio ef-summer ef-elea-light ef-maris-light ef-melissa-light ef-trio-light ef-reverie)
            :evening   (modus-vivendi-tinted ef-rosa ef-elea-dark ef-maris-dark ef-melissa-dark ef-trio-dark ef-dream)
            :dusk      (ef-bio ef-duo-dark)))
  
  ;; Use your custom configuration
  (setq theme-buffet-menu 'end-user)
  
  ;; Start period-based switching
  (theme-buffet-end-user)
  
  ;; Enable mode
  (theme-buffet-mode 1))


(use-package nerd-icons)

(use-package nerd-icons-completion
  :after marginalia
  :config
  (add-hook 'marginalia-mode-hook #'nerd-icons-completion-marginalia-setup))

(use-package nerd-icons-corfu
  :after corfu
  :config
  (add-to-list 'corfu-margin-formatters #'nerd-icons-corfu-formatter))

(use-package nerd-icons-dired
  :hook
  (dired-mode . nerd-icons-dired-mode))

(use-package spacious-padding
  :straight t
  :config
  (setq spacious-padding-subtle-frame-lines
     	`( :mode-line-active 'default
           :mode-line-inactive vertical-border))
  :custom
  (line-spacing 3)
  (spacious-padding-mode 1))

;; Highlight matching parentheses
(show-paren-mode 1)
(use-package rainbow-delimiters
  :hook (prog-mode . rainbow-delimiters-mode))
#+END_SRC

** font
:PROPERTIES:
:ID:       7a6d640f-a783-4620-8c01-fda95d850d34
:END:
#+BEGIN_SRC emacs-lisp
(use-package fontaine
  :straight t
  :init
  ;; Set the state file location BEFORE the package loads
  (setq fontaine-latest-state-file
        (locate-user-emacs-file "fontaine-latest-state.eld"))

  :config
  ;; Configure presets AFTER the package loads
  (setq fontaine-presets
        '((small
           :default-family "Aporetic Serif Mono"
           :default-height 80
           :variable-pitch-family "Aporetic Sans")
          (regular) ; uses all fallback values and is named `regular'
          (medium
           :default-weight semilight
           :default-height 115
           :bold-weight extrabold)
          (large
           :inherit medium
           :default-height 140)
          (presentation
           :default-height 180)
          (t
           ;; Default preset with all properties
           :default-family "Aporetic Sans Mono"
           :default-weight regular
           :default-height 100

           :fixed-pitch-family nil ; falls back to :default-family
           :fixed-pitch-weight nil ; falls back to :default-weight
           :fixed-pitch-height 1.0

           :fixed-pitch-serif-family nil
           :fixed-pitch-serif-weight nil
           :fixed-pitch-serif-height 1.0

           :variable-pitch-family "Aporetic Serif"
           :variable-pitch-weight nil
           :variable-pitch-height 1.0

           :mode-line-active-family nil
           :mode-line-active-weight nil
           :mode-line-active-height 0.9

           :mode-line-inactive-family nil
           :mode-line-inactive-weight nil
           :mode-line-inactive-height 0.9

           :header-line-family nil
           :header-line-weight nil
           :header-line-height 0.9

           :line-number-family nil
           :line-number-weight nil
           :line-number-height 0.9

           :tab-bar-family nil
           :tab-bar-weight nil
           :tab-bar-height 1.0

           :tab-line-family nil
           :tab-line-weight nil
           :tab-line-height 1.0

           :bold-family nil
           :bold-weight bold

           :italic-family nil
           :italic-slant italic

           :line-spacing nil)))

  ;; Set the initial preset
  (fontaine-set-preset (or (fontaine-restore-latest-preset) 'regular))

  ;; Enable fontaine-mode to persist settings
  (fontaine-mode 1)

  :bind ("C-c f" . fontaine-set-preset))

(use-package show-font
  :bind
  (("C-c s f" . show-font-select-preview)
   ("C-c s t" . show-font-tabulated)))
#+END_SRC

#+RESULTS:
: fontaine-set-preset

* Evil Mode (Vim Emulation)
:PROPERTIES:
:ID:       1e116fd6-7265-4aa8-a377-41f8203de5b6
:END:
#+BEGIN_SRC emacs-lisp
;;; Evil Mode (Vim Emulation)

(use-package evil
  :init
  (setq evil-want-integration t) ;; This is optional since it's already set to t by default.
  (setq evil-want-keybinding nil)
  (setq evil-want-C-i-jump nil)
  :config
  (evil-mode 1))

(use-package evil-collection
  :after evil
  :config
  (evil-collection-init))

;; More comprehensive escape key behavior
(use-package evil-escape
  :init
  (evil-escape-mode)
  :config
  (setq-default evil-escape-key-sequence "jk")
  (setq-default evil-escape-delay 0.2))

(use-package evil-surround
  :after evil
  :config
  (global-evil-surround-mode 1))

(use-package evil-commentary
  :after evil
  :config
  (evil-commentary-mode))
#+END_SRC
* Which Key 
:PROPERTIES:
:ID:       ca7c2dc2-1789-41f7-af26-65c29abc8343
:END:
#+BEGIN_SRC emacs-lisp
  ;;; Which Key
(use-package which-key
  :init
  (setq which-key-idle-delay 0.3)
  :config
  (which-key-mode)
  :custom
  (which-key-max-description-length 80)
  (which-key-lighter nil)
  (which-key-sort-order 'which-key-description-order)
  (which-key-side-window-location 'bottom)
  (which-key-popup-type 'minibuffer))
#+END_SRC
* Completion Framework
** Vertico, Marginalia, and Orderless
:PROPERTIES:
:ID:       1a08214c-f237-4859-b67b-1e9ba5df4817
:END:
#+BEGIN_SRC emacs-lisp
  ;;; Completion Framework
;; minibuffer completion
(use-package vertico
  :config (vertico-mode))


;; Emacs minibuffer configurations.
(use-package emacs
  :custom
  ;; Enable context menu. `vertico-multiform-mode' adds a menu in the minibuffer
  ;; to switch display modes.
  (context-menu-mode t)
  ;; Support opening new minibuffers from inside existing minibuffers.
  (enable-recursive-minibuffers t)
  ;; Hide commands in M-x which do not work in the current mode.  Vertico
  ;; commands are hidden in normal buffers. This setting is useful beyond
  ;; Vertico.
  ; (read-extended-command-predicate #'command-completion-default-include-p)
  ;; Do not allow the cursor in the minibuffer prompt
  (minibuffer-prompt-properties
   '(read-only t cursor-intangible t face minibuffer-prompt)))


;; vertico uses posframe (frame in center of screen)
(use-package vertico-posframe
  :init (vertico-posframe-mode 1))

;; adds helpful info about options in minibuffer
(use-package marginalia
  :init (marginalia-mode 1))

(use-package orderless
  :custom
  (completion-styles '(orderless flex basic))
  (completion-category-overrides '((file (styles basic partial-completion)))))

;; one column that does not take up whole screen
(setq completions-format 'one-column)
(unless (version< emacs-version "29.0")
  (setq completions-max-height 20))

;; similar to Prot's MCT package
(setq completion-auto-help 'always
      completion-auto-select 'second-tab
      completion-show-help nil
      completions-sort nil
      completions-header-format nil)

(file-name-shadow-mode 1)

(add-hook 'rfn-eshadow-update-overlay-hook #'vertico-directory-tidy)
#+END_SRC

** Consult, Corfu, and Embark
:PROPERTIES:
:ID:       2bb91e07-ffaa-4208-9894-aa7315b951ce
:END:
#+BEGIN_SRC emacs-lisp
;; Enhanced command, buffer, and file selection
(use-package consult
  :bind (("C-x b" . consult-buffer)
         ("C-x 4 b" . consult-buffer-other-window)
         ("C-c s" . consult-ripgrep)
         ("C-s" . consult-line)))

(use-package savehist
  :straight nil
  :hook (after-init . savehist-mode))

(use-package corfu
  :init (global-corfu-mode)
  :bind (:map corfu-map
	      ("<tab>" . corfu-complete)
	      ("TAB" . corfu-complete)
	      ("RET" . nil)
	      )
  :custom
  (tab-always-indent 'complete)
  (corfu-preselect 'prompt)
  (corfu-preview-current nil)
  (corfu-min-width 20)
  (corfu-auto t)
  (corfu-auto-prefix 2)
  (corfu-cycle t)
  (setq corfu-popupinfo-delay '(1.25 . 0.5))
  (corfu-popupinfo-mode 1) ; shows documentation after `corfu-popupinfo-delay'

  ;; Sort by input history (no need to modify `corfu-sort-function').
  (with-eval-after-load 'savehist
    (corfu-history-mode 1)
    (add-to-list 'savehist-additional-variables 'corfu-history)))

(use-package cape
  ;; Bind prefix keymap providing all Cape commands under a mnemonic key.
  ;; Press C-c p ? to for help.
  :bind ("C-c p" . cape-prefix-map) ;; Alternative key: M-<tab>, M-p, M-+
  ;; Alternatively bind Cape commands individually.
  ;; :bind (("C-c p d" . cape-dabbrev)
  ;;        ("C-c p h" . cape-history)
  ;;        ("C-c p f" . cape-file)
  ;;        ...)
  :init
  ;; Add to the global default value of `completion-at-point-functions' which is
  ;; used by `completion-at-point'.  The order of the functions matters, the
  ;; first function returning a result wins.  Note that the list of buffer-local
  ;; completion functions takes precedence over the global list.
  (add-hook 'completion-at-point-functions #'cape-dabbrev)
  (add-hook 'completion-at-point-functions #'cape-file)
  (add-hook 'completion-at-point-functions #'cape-elisp-block)
  ;; (add-hook 'completion-at-point-functions #'cape-history)
  ;; ...
  )
(use-package embark
  :bind
  (("C-," . embark-act)         ;; pick some comfortable binding
   ("C-;" . embark-dwim)        ;; good alternative: M-.
   ("C-h b" . embark-bindings)) ;; alternative for `describe-bindings'

  :init
  ;; Optionally replace the key help with a completing-read interface
  (setq prefix-help-command #'embark-prefix-help-command)

  :config
  (vertico-multiform-mode)
  (add-to-list 'vertico-multiform-categories '(embark-keybinding grid))

  ;; Hide the mode line of the Embark live/completions buffers
  (add-to-list 'display-buffer-alist
               '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
                 nil
                 (window-parameters (mode-line-format . none)))))

;; Consult users will also want the embark-consult package.
(use-package embark-consult
  :after (embark consult)
  :demand t ; only necessary if you have the hook below
  ;; if you want to have consult previews as you move around an
  ;; auto-updating embark collect buffer
  :hook
  (embark-collect-mode . consult-preview-at-point-mode))
#+END_SRC


* Development Tools and Features
** Magit, LSP, Treesitter, etc
:PROPERTIES:
:ID:       88506ca6-252f-4bc9-a01f-5da8ee76daba
:END:
#+BEGIN_SRC emacs-lisp
      ;;; Development Tools & Features
(use-package vterm)

;; Git integration
(use-package magit
  :commands magit-status)

(setq-default ispell-program-name "hunspell")


;; LSP support using built-in eglot
(use-package eglot
  :straight nil
  :hook ((python-ts-mode . eglot-ensure)  ; Python
         ;(r-mode . eglot-ensure)           ; R
         (css-mode . eglot-ensure)         ; CSS
         (html-mode . eglot-ensure)        ; HTML
         (web-mode . eglot-ensure))        ; Web templates
  :config
  ;; Configure LSP servers
  (add-to-list 'eglot-server-programs '(python-ts-mode . ("pylsp")))
  (add-to-list 'eglot-server-programs '(r-mode . ("R" "--slave" "-e" "languageserver::run()")))
  (add-to-list 'eglot-server-programs '(web-mode . ("vscode-html-language-server" "--stdio")))
  (setq eglot-autoshutdown t  ; Shutdown server when last buffer is killed
        eglot-sync-connect nil))  ; Don't block on connection
;; try this later so that pylsp is running from uv
;; `((python-ts-mode python-mode) . ("uv" "tool" "run" "--from" "python-lsp-server[all]" "pylsp")))

;; Syntax checking
(use-package flycheck
  :init (global-flycheck-mode))

(use-package flycheck-eglot
  :after (flycheck eglot)
  :config
  (global-flycheck-eglot-mode 1))

(use-package yasnippet
  :init (yas-global-mode 1))

(use-package yasnippet-snippets) ;; Collection of snippets

;; Delete the selected text upon text insertion
(use-package delsel
  :straight nil ; no need to install it as it is built-in
  :hook (after-init . delete-selection-mode))

(use-package treesit-auto
  :custom
  (treesit-auto-install 'prompt)
  :config
  (treesit-auto-add-to-auto-mode-alist 'all)
  (global-treesit-auto-mode))
#+END_SRC
** eshell
:PROPERTIES:
:ID:       1f089cdd-3afe-4804-a5ea-dcd219f0ae4a
:END:
#+begin_src emacs-lisp
;;; eshell customization
(use-package eshell
  :straight nil  ; built-in
  :bind ("C-c e" . eshell)
  :config
  ;; Better prompt
  (defun my/eshell-prompt ()
    (concat
     ;; Directory
     (propertize (abbreviate-file-name (eshell/pwd))
                 'face '(:foreground "purple"))
     ;; Git branch if in repo
     (when-let ((branch (magit-get-current-branch)))
       (propertize (format " (%s)" branch)
                   'face '(:foreground "green")))
     ;; Prompt symbol
     (if (= (user-uid) 0) " # " " $ ")))

  (setq eshell-prompt-function #'my/eshell-prompt)

  ;; History settings
  (setq eshell-history-size 10000
        eshell-hist-ignoredups t
        eshell-save-history-on-exit t
        eshell-history-file-name
        (expand-file-name "eshell/history" user-emacs-directory))

  ;; Scrolling behavior
  (setq eshell-scroll-to-bottom-on-input t
        eshell-scroll-show-maximum-output t
        eshell-buffer-maximum-lines 10000)

  ;; Prefer Emacs commands over external
  (setq eshell-prefer-lisp-functions t
        eshell-prefer-lisp-variables t)

  ;; Enable smart mode (optional - try without first)
  ;; Load the smart module
  (require 'em-smart)

  ;; Add it to modules list
  (add-to-list 'eshell-modules-list 'eshell-smart)

  ;; Better completion
  (setq eshell-cmpl-ignore-case t))
#+end_src
** Python
:PROPERTIES:
:ID:       2c6f0e37-786d-477e-b33f-8ac8862a5cf4
:END:
#+BEGIN_SRC emacs-lisp
;;;; Python
(use-package python
  :straight nil
  :init
  :config
  (setq python-indent-offset 4)
  (setq python-shell-completion-native-enable nil))

(use-package uv
  :straight (uv :type git :host github :repo "johannes-mueller/uv.el")
  :init
  (add-to-list 'treesit-language-source-alist '(toml "https://github.com/tree-sitter-grammars/tree-sitter-toml"))
  (unless (treesit-language-available-p 'toml)
    (treesit-install-language-grammar 'toml)))

(use-package py-vterm-interaction
  :after python
  :hook (python-ts-mode . py-vterm-interaction-mode)
  :config
    ;;; Suggested:
  ;; (setq-default py-vterm-interaction-repl-program "ipython")
  ;;(setq-default py-vterm-interaction-silent-cells t)
  )
#+END_SRC

** R Support
:PROPERTIES:
:ID:       becb983f-cc27-43cd-a277-d4baf7fff6b7
:END:
#+BEGIN_SRC emacs-lisp
;;;; R support

;; R operator insertion functions
(defun my/insert-r-assignment ()
  "Insert R assignment operator with spaces."
  (interactive)
  (insert " <- "))

(defun my/insert-r-pipe-native ()
  "Insert R native pipe operator with spaces."
  (interactive)
  (insert " |> "))

(use-package ess
  :commands (R r ess-r-mode)
  :mode (("\\.R\\'" . ess-r-mode)
         ("\\.r\\'" . ess-r-mode)
         ("\\.Rmd\\'" . poly-markdown+r-mode))
    :custom
  (setq ess-ask-for-ess-directory nil)
  (setq ess-local-process-name "R")
  (setq ess-use-flymake nil)
  (setq ess-use-eldoc nil)
  (setq ess-eldoc-show-on-symbol nil)
  (setq inferior-R-args "--no-save --no-restore-data --quiet")
  :config
  (setq ess-history-file nil) 
  (setq ess-idle-timer-interval 0.5)

  (define-key ess-r-mode-map (kbd "M--") #'my/insert-r-assignment)
  (define-key ess-r-mode-map (kbd "C-S-m") #'my/insert-r-pipe-native)
  
  ;; Also bind in the inferior (REPL) buffer
  (define-key inferior-ess-r-mode-map (kbd "M--") #'my/insert-r-assignment)
  (define-key inferior-ess-r-mode-map (kbd "C-S-m") #'my/insert-r-pipe-native))


;; (defun my/start-httpgd ()
;;   "Start httpgd server for R plotting."
;;   (interactive)
;;   (ess-eval-linewise "if (!httpgd::hgd_url()) httpgd::hgd(host='127.0.0.1', port=8888)")
;;   (browse-url "http://127.0.0.1:8888/live"))
;; 
;; ;; Bind to a key
;; (with-eval-after-load 'ess-r-mode
;;   (define-key ess-r-mode-map (kbd "C-c C-g") #'my/start-httpgd))

(use-package ess-plot
  :straight (ess-plot :type git :host github :repo "DennieTeMolder/ess-plot")
  :hook (ess-r-post-run . ess-plot-on-startup-h))

(use-package format-all
  :commands (format-all-buffer)
  :config
  (setq-default format-all-formatters '(("R" styler))))

(use-package ess-view-data
  :after ess
  :commands (ess-view-data-print))

(use-package poly-R
  :defer t
  :mode (("\\.Rmd\\'" . poly-markdown+r-mode)))

(use-package quarto-mode
  :defer t
  :mode ("\\.qmd\\'" . quarto-mode))
#+END_SRC

#+RESULTS:
: ((\.epub\' . nov-mode) (\.pdf\' . pdf-view-mode) (\.hledger\' . ledger-mode) (\.ledger\' . ledger-mode) (\.md\' . markdown-mode) (README\.md\' . gfm-mode) (\.csv\' . csv-mode) (\.njk\' . web-mode) (\.jsx?\' . web-mode) (\.css\' . web-mode) (\.html?\' . web-mode) (\.qmd\' . quarto-mode) (\.qmd\' . poly-quarto-mode) (\.cpp[rR]\' . poly-c++r-mode) (\.[Rr]cpp\' . poly-r+c++-mode) (\.[rR]brew\' . poly-brew+r-mode) (\.[rR]html\' . poly-html+r-mode) (\.rapport\' . poly-rapport-mode) (\.[rR]md\' . poly-markdown+r-mode) (\.[rR]nw\' . poly-noweb+r-mode) (\.Snw\' . poly-noweb+r-mode) (\.nw\' . poly-noweb-mode) (\.md\' . poly-markdown-mode) (\.\(?:md\|markdown\|mkd\|mdown\|mkdn\|mdwn\)\' . markdown-mode) (\.tsv\' . tsv-mode) (\.[Cc][Ss][Vv]\' . csv-mode) (\.Rmd\' . poly-markdown+r-mode) (\.r\' . ess-r-mode) (\.R\' . ess-r-mode) (\.[Ss][Aa][Ss]\' . SAS-mode) (\.Sout\' . S-transcript-mode) (\.[Ss]t\' . S-transcript-mode) (\.Rd\' . Rd-mode) (DESCRIPTION\' . conf-colon-mode) (/Makevars\(\.win\)?\' . makefile-mode) (\.[Rr]out\' . ess-r-transcript-mode) (CITATION\' . ess-r-mode) (NAMESPACE\' . ess-r-mode) (\.[rR]profile\' . ess-r-mode) (\.[rR]\' . ess-r-mode) (/R/.*\.q\' . ess-r-mode) (\.[Jj][Aa][Gg]\' . ess-jags-mode) (\.[Bb][Mm][Dd]\' . ess-bugs-mode) (\.[Bb][Oo][Gg]\' . ess-bugs-mode) (\.[Bb][Uu][Gg]\' . ess-bugs-mode) (\.ya?ml\' . yaml-ts-mode) (\.ts\' . typescript-ts-mode) (\.tsx\' . tsx-ts-mode) (\.toml\' . toml-ts-mode) (\.rs\' . rust-ts-mode) (\(?:\.\(?:rbw?\|ru\|rake\|thor\|jbuilder\|rabl\|gemspec\|podspec\)\|/\(?:Gem\|Rake\|Cap\|Thor\|Puppet\|Berks\|Brew\|Vagrant\|Guard\|Pod\)file\)\' . ruby-ts-mode) (\.py[iw]?\' . python-ts-mode) (\.lua\' . lua-ts-mode) (\.json\' . json-ts-mode) (\.js\' . js-ts-mode) (\.java\' . java-ts-mode) (\.html\' . html-ts-mode) (\.heex\' . heex-ts-mode) (go\.mod\' . go-mod-ts-mode) (\.go\' . go-ts-mode) (\.ex\' . elixir-ts-mode) ([/\]\(?:Containerfile\|Dockerfile\)\(?:\.[^/\]*\)?\' . dockerfile-ts-mode) (\.css\' . css-ts-mode) (\.cpp\' . c++-ts-mode) (\.cmake\' . cmake-ts-mode) (\.cs\' . csharp-ts-mode) (\.c\' . c-ts-mode) (\.sh\' . bash-ts-mode) (/git-rebase-todo\' . git-rebase-mode) (\.\(ttf\|otf\)\' . show-font-mode) (\.gpg\(~\|\.~[0-9]+~\)?\' nil epa-file) (\.elc\' . elisp-byte-code-mode) (\.zst\' nil jka-compr) (\.dz\' nil jka-compr) (\.xz\' nil jka-compr) (\.lzma\' nil jka-compr) (\.lz\' nil jka-compr) (\.g?z\' nil jka-compr) (\.bz2\' nil jka-compr) (\.Z\' nil jka-compr) (\.vr[hi]?\' . vera-mode) (\(?:\.\(?:rbw?\|ru\|rake\|thor\|axlsx\|jbuilder\|rabl\|gemspec\|podspec\)\|/\(?:Gem\|Rake\|Cap\|Thor\|Puppet\|Berks\|Brew\|Fast\|Vagrant\|Guard\|Pod\)file\)\' . ruby-mode) (\.re?st\' . rst-mode) (/\(?:Pipfile\|\.?flake8\)\' . conf-mode) (\.py[iw]?\' . python-mode) (\.m\' . octave-maybe-mode) (\.less\' . less-css-mode) (\.editorconfig\' . editorconfig-conf-mode) (\.scss\' . scss-mode) (\.cs\' . csharp-mode) (\.awk\' . awk-mode) (\.\(u?lpc\|pike\|pmod\(\.in\)?\)\' . pike-mode) (\.idl\' . idl-mode) (\.java\' . java-mode) (\.m\' . objc-mode) (\.ii\' . c++-mode) (\.i\' . c-mode) (\.lex\' . c-mode) (\.y\(acc\)?\' . c-mode) (\.h\' . c-or-c++-mode) (\.c\' . c-mode) (\.\(CC?\|HH?\)\' . c++-mode) (\.[ch]\(pp\|xx\|\+\+\)\' . c++-mode) (\.\(cc\|hh\)\' . c++-mode) (\.\(bat\|cmd\)\' . bat-mode) (\.[sx]?html?\(\.[a-zA-Z_]+\)?\' . mhtml-mode) (\.svgz?\' . image-mode) (\.svgz?\' . xml-mode) (\.x[bp]m\' . image-mode) (\.x[bp]m\' . c-mode) (\.p[bpgn]m\' . image-mode) (\.tiff?\' . image-mode) (\.gif\' . image-mode) (\.png\' . image-mode) (\.jpe?g\' . image-mode) (\.webp\' . image-mode) (\.te?xt\' . text-mode) (\.[tT]e[xX]\' . tex-mode) (\.ins\' . tex-mode) (\.ltx\' . latex-mode) (\.dtx\' . doctex-mode) (\.org\' . org-mode) (\.dir-locals\(?:-2\)?\.el\' . lisp-data-mode) (\.eld\' . lisp-data-mode) (eww-bookmarks\' . lisp-data-mode) (tramp\' . lisp-data-mode) (/archive-contents\' . lisp-data-mode) (places\' . lisp-data-mode) (\.emacs-places\' . lisp-data-mode) (\.el\' . emacs-lisp-mode) (Project\.ede\' . emacs-lisp-mode) (\(?:\.\(?:scm\|sls\|sld\|stk\|ss\|sch\)\|/\.guile\)\' . scheme-mode) (\.l\' . lisp-mode) (\.li?sp\' . lisp-mode) (\.[fF]\' . fortran-mode) (\.for\' . fortran-mode) (\.p\' . pascal-mode) (\.pas\' . pascal-mode) (\.\(dpr\|DPR\)\' . delphi-mode) (\.\([pP]\([Llm]\|erl\|od\)\|al\)\' . perl-mode) (Imakefile\' . makefile-imake-mode) (Makeppfile\(?:\.mk\)?\' . makefile-makepp-mode) (\.makepp\' . makefile-makepp-mode) (\.mk\' . makefile-gmake-mode) (\.make\' . makefile-gmake-mode) ([Mm]akefile\' . makefile-gmake-mode) (\.am\' . makefile-automake-mode) (\.texinfo\' . texinfo-mode) (\.te?xi\' . texinfo-mode) (\.[sS]\' . asm-mode) (\.asm\' . asm-mode) (\.css\' . css-mode) (\.mixal\' . mixal-mode) (\.gcov\' . compilation-mode) (/\.[a-z0-9-]*gdbinit . gdb-script-mode) (-gdb\.gdb . gdb-script-mode) ([cC]hange\.?[lL]og?\' . change-log-mode) ([cC]hange[lL]og[-.][0-9]+\' . change-log-mode) (\$CHANGE_LOG\$\.TXT . change-log-mode) (\.scm\.[0-9]*\' . scheme-mode) (\.[ckz]?sh\'\|\.shar\'\|/\.z?profile\' . sh-mode) (\.bash\' . sh-mode) (/PKGBUILD\' . sh-mode) (\(/\|\`\)\.\(bash_\(profile\|history\|log\(in\|out\)\)\|z?log\(in\|out\)\)\' . sh-mode) (\(/\|\`\)\.\(shrc\|zshrc\|m?kshrc\|bashrc\|t?cshrc\|esrc\)\' . sh-mode) (\(/\|\`\)\.\([kz]shenv\|xinitrc\|startxrc\|xsession\)\' . sh-mode) (\.m?spec\' . sh-mode) (\.m[mes]\' . nroff-mode) (\.man\' . nroff-mode) (\.sty\' . latex-mode) (\.cl[so]\' . latex-mode) (\.bbl\' . latex-mode) (\.bib\' . bibtex-mode) (\.bst\' . bibtex-style-mode) (\.sql\' . sql-mode) (\(acinclude\|aclocal\|acsite\)\.m4\' . autoconf-mode) (\.m[4c]\' . m4-mode) (\.mf\' . metafont-mode) (\.mp\' . metapost-mode) (\.vhdl?\' . vhdl-mode) (\.article\' . text-mode) (\.letter\' . text-mode) (\.i?tcl\' . tcl-mode) (\.exp\' . tcl-mode) (\.itk\' . tcl-mode) (\.icn\' . icon-mode) (\.sim\' . simula-mode) (\.mss\' . scribe-mode) (\.f9[05]\' . f90-mode) (\.f0[38]\' . f90-mode) (\.indent\.pro\' . fundamental-mode) (\.\(pro\|PRO\)\' . idlwave-mode) (\.srt\' . srecode-template-mode) (\.prolog\' . prolog-mode) (\.tar\' . tar-mode) (\.\(arc\|zip\|lzh\|lha\|zoo\|[jew]ar\|xpi\|rar\|cbr\|7z\|squashfs\|ARC\|ZIP\|LZH\|LHA\|ZOO\|[JEW]AR\|XPI\|RAR\|CBR\|7Z\|SQUASHFS\)\' . archive-mode) (\.oxt\' . archive-mode) (\.\(deb\|[oi]pk\)\' . archive-mode) (\`/tmp/Re . text-mode) (/Message[0-9]*\' . text-mode) (\`/tmp/fol/ . text-mode) (\.oak\' . scheme-mode) (\.sgml?\' . sgml-mode) (\.x[ms]l\' . xml-mode) (\.dbk\' . xml-mode) (\.dtd\' . sgml-mode) (\.ds\(ss\)?l\' . dsssl-mode) (\.js[mx]?\' . javascript-mode) (\.har\' . javascript-mode) (\.json\' . js-json-mode) (\.[ds]?va?h?\' . verilog-mode) (\.by\' . bovine-grammar-mode) (\.wy\' . wisent-grammar-mode) (\.erts\' . erts-mode) ([:/\]\..*\(emacs\|gnus\|viper\)\' . emacs-lisp-mode) (\`\..*emacs\' . emacs-lisp-mode) ([:/]_emacs\' . emacs-lisp-mode) (/crontab\.X*[0-9]+\' . shell-script-mode) (\.ml\' . lisp-mode) (\.ld[si]?\' . ld-script-mode) (ld\.?script\' . ld-script-mode) (\.xs\' . c-mode) (\.x[abdsru]?[cnw]?\' . ld-script-mode) (\.zone\' . dns-mode) (\.soa\' . dns-mode) (\.asd\' . lisp-mode) (\.\(asn\|mib\|smi\)\' . snmp-mode) (\.\(as\|mi\|sm\)2\' . snmpv2-mode) (\.\(diffs?\|patch\|rej\)\' . diff-mode) (\.\(dif\|pat\)\' . diff-mode) (\.[eE]?[pP][sS]\' . ps-mode) (\.\(?:PDF\|EPUB\|CBZ\|FB2\|O?XPS\|DVI\|OD[FGPST]\|DOCX\|XLSX?\|PPTX?\|pdf\|epub\|cbz\|fb2\|o?xps\|djvu\|dvi\|od[fgpst]\|docx\|xlsx?\|pptx?\)\' . doc-view-mode-maybe) (configure\.\(ac\|in\)\' . autoconf-mode) (\.s\(v\|iv\|ieve\)\' . sieve-mode) (BROWSE\' . ebrowse-tree-mode) (\.ebrowse\' . ebrowse-tree-mode) (#\*mail\* . mail-mode) (\.g\' . antlr-mode) (\.mod\' . m2-mode) (\.ses\' . ses-mode) (\.docbook\' . sgml-mode) (\.com\' . dcl-mode) (/config\.\(?:bat\|log\)\' . fundamental-mode) (/\.?\(authinfo\|netrc\)\' . authinfo-mode) (\.\(?:[iI][nN][iI]\|[lL][sS][tT]\|[rR][eE][gG]\|[sS][yY][sS]\)\' . conf-mode) (\.la\' . conf-unix-mode) (\.ppd\' . conf-ppd-mode) (java.+\.conf\' . conf-javaprop-mode) (\.properties\(?:\.[a-zA-Z0-9._-]+\)?\' . conf-javaprop-mode) (\.toml\' . conf-toml-mode) (\.desktop\' . conf-desktop-mode) (/\.redshift\.conf\' . conf-windows-mode) (\`/etc/\(?:DIR_COLORS\|ethers\|.?fstab\|.*hosts\|lesskey\|login\.?de\(?:fs\|vperm\)\|magic\|mtab\|pam\.d/.*\|permissions\(?:\.d/.+\)?\|protocols\|rpc\|services\)\' . conf-space-mode) (\`/etc/\(?:acpid?/.+\|aliases\(?:\.d/.+\)?\|default/.+\|group-?\|hosts\..+\|inittab\|ksysguarddrc\|opera6rc\|passwd-?\|shadow-?\|sysconfig/.+\)\' . conf-mode) ([cC]hange[lL]og[-.][-0-9a-z]+\' . change-log-mode) (/\.?\(?:gitconfig\|gnokiirc\|hgrc\|kde.*rc\|mime\.types\|wgetrc\)\' . conf-mode) (/\.mailmap\' . conf-unix-mode) (/\.\(?:asound\|enigma\|fetchmail\|gltron\|gtk\|hxplayer\|mairix\|mbsync\|msmtp\|net\|neverball\|nvidia-settings-\|offlineimap\|qt/.+\|realplayer\|reportbug\|rtorrent\.\|screen\|scummvm\|sversion\|sylpheed/.+\|xmp\)rc\' . conf-mode) (/\.\(?:gdbtkinit\|grip\|mpdconf\|notmuch-config\|orbital/.+txt\|rhosts\|tuxracer/options\)\' . conf-mode) (/\.?X\(?:default\|resource\|re\)s\> . conf-xdefaults-mode) (/X11.+app-defaults/\|\.ad\' . conf-xdefaults-mode) (/X11.+locale/.+/Compose\' . conf-colon-mode) (/X11.+locale/compose\.dir\' . conf-javaprop-mode) (\.~?[0-9]+\.[0-9][-.0-9]*~?\' nil t) (\.\(?:orig\|in\|[bB][aA][kK]\)\' nil t) ([/.]c\(?:on\)?f\(?:i?g\)?\(?:\.[a-zA-Z0-9._-]+\)?\' . conf-mode-maybe) (\.[1-9]\' . nroff-mode) (\.art\' . image-mode) (\.avs\' . image-mode) (\.bmp\' . image-mode) (\.cmyk\' . image-mode) (\.cmyka\' . image-mode) (\.crw\' . image-mode) (\.dcr\' . image-mode) (\.dcx\' . image-mode) (\.dng\' . image-mode) (\.dpx\' . image-mode) (\.fax\' . image-mode) (\.heic\' . image-mode) (\.hrz\' . image-mode) (\.icb\' . image-mode) (\.icc\' . image-mode) (\.icm\' . image-mode) (\.ico\' . image-mode) (\.icon\' . image-mode) (\.jbg\' . image-mode) (\.jbig\' . image-mode) (\.jng\' . image-mode) (\.jnx\' . image-mode) (\.miff\' . image-mode) (\.mng\' . image-mode) (\.mvg\' . image-mode) (\.otb\' . image-mode) (\.p7\' . image-mode) (\.pcx\' . image-mode) (\.pdb\' . image-mode) (\.pfa\' . image-mode) (\.pfb\' . image-mode) (\.picon\' . image-mode) (\.pict\' . image-mode) (\.rgb\' . image-mode) (\.rgba\' . image-mode) (\.tga\' . image-mode) (\.wbmp\' . image-mode) (\.webp\' . image-mode) (\.wmf\' . image-mode) (\.wpg\' . image-mode) (\.xcf\' . image-mode) (\.xmp\' . image-mode) (\.xwd\' . image-mode) (\.yuv\' . image-mode) (\.tgz\' . tar-mode) (\.tbz2?\' . tar-mode) (\.txz\' . tar-mode) (\.tzst\' . tar-mode))

** Web Development
:PROPERTIES:
:ID:       0b162172-ac9f-4f08-9fa1-9e96cc34c800
:END:
#+BEGIN_SRC emacs-lisp
;;;; Web development
(use-package web-mode
  :mode (("\\.html?\\'" . web-mode)
         ("\\.css\\'" . web-mode)
         ("\\.jsx?\\'" . web-mode)
         ("\\.njk\\'" . web-mode)) ;; Nunjucks templates
  :config
  (setq web-mode-markup-indent-offset 2)
  (setq web-mode-css-indent-offset 2)
  (setq web-mode-code-indent-offset 2)
  (setq web-mode-enable-auto-pairing t)
  (setq web-mode-enable-auto-closing t)
  (setq web-mode-enable-css-colorization t))

;; Emmet for fast HTML/CSS writing
(use-package emmet-mode
  :hook (web-mode . emmet-mode))
#+END_SRC
** Data Work Formats
:PROPERTIES:
:ID:       19a79fa2-44d8-4064-be7e-44096ee3dbc4
:END:
#+BEGIN_SRC emacs-lisp
  ;;;; data work formats

;; CSV/TSV file handling
(use-package csv-mode
  :mode "\\.csv\\'")

;; Support for markdown docs
(use-package markdown-mode
  :mode ("README\\.md\\'" . gfm-mode)
  :mode ("\\.md\\'" . markdown-mode))

;; Hledger
(use-package ledger-mode
  :custom
  ((ledger-binary-path "hledger")
   (ledger-mode-should-check-version nil)
   (ledger-report-auto-width nil)
   (ledger-report-links-in-register nil)
   (ledger-report-native-highlighting-arguments '("--color=always")))
  :mode ("\\.hledger\\'" "\\.ledger\\'"))
#+end_src
* org mode config
:PROPERTIES:
:ID:       034e58ad-6d40-477a-9a7a-c16a566a943c
:end:
#+begin_src emacs-lisp
;;; Org Mode Configuration
(use-package org
  :straight nil
  :config
  ;; Global keybindings (set early so they're available)
  (global-set-key (kbd "C-c c") 'org-capture)
  (global-set-key (kbd "C-c a") 'org-agenda)
  (global-set-key (kbd "C-c l") 'org-store-link)

  :custom
  ;; Appearance
  (org-startup-indented t)
  (org-hide-emphasis-markers t)
  (org-startup-with-inline-images t)
  (org-image-actual-width '(450))
  (org-pretty-entities t)
  (org-use-sub-superscripts "{}")

  ;; Editing behavior
  (org-M-RET-may-split-line '((default . nil)))
  (org-insert-heading-respect-content t)
  (org-return-follows-link t)
  (org-fold-catch-invisible-edits 'show-and-error)

  ;; Links
  (org-id-link-to-org-use-id t))
#+end_src

** Org Babel (Code Blocks)
:PROPERTIES:
:ID:       org-babel
:END:

Configuration for executing code within org documents.

*** Language Support
:PROPERTIES:
:ID:       83309260-d7d5-411e-94df-a89a0f73c6f7
:END:
#+begin_src emacs-lisp
(use-package org
  :config
  ;; Don't ask for confirmation when executing code blocks
  (setq org-confirm-babel-evaluate nil)

  ;; Enable languages for babel
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((python . t)
     (R . t)
     (emacs-lisp . t)
     (shell . t)))

  ;; Source block editing behavior
  (setq org-src-fontify-natively t      ; Syntax highlight in src blocks
        org-src-tab-acts-natively t     ; Tab works like in the language's major mode
        org-src-preserve-indentation t  ; Don't add extra indentation
        org-edit-src-content-indentation 0))
#+end_src

*** Source Block Templates
:PROPERTIES:
:ID:       44cee3f7-f81b-4708-9408-3b84f588e6d2
:END:
These let you type =<r= then =TAB= to insert a code block.

#+begin_src emacs-lisp
(with-eval-after-load 'org
  (setq org-structure-template-alist
        '(("s" . "src")
          ;; Emacs Lisp (lowercase e for simple, uppercase E for fancy)
          ("e" . "src emacs-lisp")
          ("E" . "src emacs-lisp :results value code :lexical t")
          ;; Python
          ("p" . "src python")
          ("po" . "src python :results output")
          ("ps" . "src python :session :results output")
          ;; R
          ("r" . "src R")
          ("rp" . "src R :results output graphics file :file plot.png")
          ;; Shell
          ("b" . "src bash")
          ("sh" . "src shell :results output")
          ;; Documentation blocks
          ("x" . "example")
          ("q" . "quote")
          ("v" . "verse"))))
#+end_src

*** R-Specific Babel Settings
:PROPERTIES:
:ID:       50ba0df7-45cb-4d8c-9d4a-af1bf0d3f967
:END:
Default header arguments for R code blocks.

#+begin_src emacs-lisp
(with-eval-after-load 'org
  (setq org-babel-default-header-args:R
        '((:session . "*R*")           ; Use persistent R session
          (:results . "output")        ; Show console output
          (:exports . "both")          ; Export code and results
          (:cache . "no")              ; Don't cache (for interactive work)
          (:prologue . "options(crayon.enabled = FALSE, cli.num_colors = 1)")
          (:tangle . "no"))))
#+end_src

*** ANSI Color Handling
:PROPERTIES:
:ID:       0221fbe3-ee66-4beb-b179-ad613bc99818
:END:
Removes ugly escape codes from R output (like from tidyverse messages).

#+begin_src emacs-lisp
(defun my/babel-ansi-colorize-results ()
  "Apply ANSI color escape sequences to Org Babel results."
  (when-let ((beg (org-babel-where-is-src-block-result nil nil)))
    (save-excursion
      (goto-char beg)
      (when (looking-at org-babel-result-regexp)
        (let ((end (org-babel-result-end))
              (ansi-color-context-region nil))
          (ansi-color-apply-on-region beg end))))))

(add-hook 'org-babel-after-execute-hook 'my/babel-ansi-colorize-results)
#+end_src

** Org Capture & Agenda
:PROPERTIES:
:ID:       org-capture-agenda
:END:

*** Capture Templates
:PROPERTIES:
:ID:       9d8187df-234c-4b7e-b798-5d27ab9de495
:END:
Quick capture for ideas and tasks.

#+begin_src emacs-lisp
(use-package org
  :config
  (setq org-capture-templates
        '(("i" "Inbox" entry
           (file+headline "~/Documents/notes/inbox.org" "Inbox")
           "* %?\n:PROPERTIES:\n:CAPTURED: %U\n:END:\n\nContext: %a"
           :empty-lines 1)

          ("t" "Todo" entry
           (file+headline "~/Documents/notes/inbox.org" "Tasks")
           "* TODO %?\n:PROPERTIES:\n:CAPTURED: %U\n:END:\n\nContext: %a"
           :empty-lines 1))))
#+end_src

*** Agenda Configuration
:PROPERTIES:
:ID:       f71b305d-9ac4-42eb-935e-41a2a8571026
:END:
#+begin_src emacs-lisp
(use-package org
  :config
  (setq org-agenda-files '("~/Documents/notes")))
#+end_src

*** TO-DO Keywords
:PROPERTIES:
:ID:       28ea1410-d78f-4de1-b036-2d5579a52ab0
:END:
#+begin_src emacs-lisp
(use-package org
  :config
  (setq org-todo-keywords
        '((sequence "TODO(t)" "NEXT(n)" "|" "DONE(d!)" "CANCELLED(c@/!)")
          (sequence "GOAL(g)" "|" "ACHIEVED(a!)" "ABANDONED(x@/!)")))

  ;; Log when tasks are completed
  (setq org-log-done 'time)
  (setq org-log-into-drawer t))
#+end_src

*** Archive Settings
:PROPERTIES:
:ID:       153e1e24-6a40-4aad-9af3-04a485489470
:END:
#+begin_src emacs-lisp
(use-package org
  :config
  (setq org-archive-location "~/Documents/notes/archive.org::datetree/"))
#+end_src

*** Dedicated Agenda Frame
:PROPERTIES:
:ID:       e9106a37-3635-45f9-8cdf-817a872f0b5b
:END:
Opens agenda in its own frame (useful with your daemon setup).

#+begin_src emacs-lisp
(defun my/dedicated-agenda-frame ()
  "Open org-agenda in a clean, dedicated frame."
  (interactive)
  (let ((display-buffer-alist
         '((".*" (display-buffer-same-window)))))
    (with-selected-frame (make-frame '((name . "*Org Agenda*")))
      (switch-to-buffer "*scratch*")
      (delete-other-windows)
      (org-agenda nil "a"))))
#+end_src

** Org Visual Enhancements
:PROPERTIES:
:ID:       org-visual
:END:

*** Org Modern
:PROPERTIES:
:ID:       d6417ee8-5a54-454d-91ef-77ed144eeb6a
:END:
A more comprehensive visual overhaul.

#+begin_src emacs-lisp
(use-package org-modern
  :hook (org-mode . org-modern-mode))
#+end_src

*** Block Completion
:PROPERTIES:
:ID:       b1f0a8d8-3901-4ff8-b7f2-27bc0a002b1e
:END:
Autocomplete for source block languages.

#+begin_src emacs-lisp
(use-package org-block-capf
  :straight (org-block-capf :type git :host github :repo "xenodium/org-block-capf")
  :hook (org-mode . org-block-capf-add-to-completion-at-point-functions))
#+end_src
#+RESULTS:
| #[0 \301\211\207 [imenu-create-index-function org-imenu-get-tree] 2] | org-modern-mode | org-block-capf-add-to-completion-at-point-functions | org-bullets-mode | #[0 \300\301\302\303\304$\207 [add-hook change-major-mode-hook org-fold-show-all append local] 5] | #[0 \300\301\302\303\304$\207 [add-hook change-major-mode-hook org-babel-show-result-all append local] 5] | org-babel-result-hide-spec | org-babel-hide-all-hashes | #[nil ((display-line-numbers-mode 0)) (t)] |

* General Settings
:PROPERTIES:
:ID:       0a71ffd7-e5e0-4346-99f6-41f77280709c
:END:
#+BEGIN_SRC emacs-lisp
;;; General Settings

(use-package text-mode
  :straight nil
  :hook
  (text-mode . visual-line-mode)
  :init
  (delete-selection-mode t)
  :custom
  (sentence-end-double-space nil)
  (scroll-error-top-bottom t)
  (save-interprogram-paste-before-kill t))

;;recent files
(recentf-mode 1)

;;comand history settings
(setq history-length 25)

;; remember and restore the last cursor location of opened files
(save-place-mode 1)

;;revert buffers when the file has been changed
(global-auto-revert-mode 1)

(setq global-auto-revert-non-file-buffers t)

;; move customization variables to a separate file and load it
(setq custom-file (locate-user-emacs-file "custom-vars.el"))
(load custom-file 'noerror 'nomessage)

;; stop creation of ~ files
(setq make-backup-files nil)

;; C-g is more helpful
(defun prot/keyboard-quit-dwim ()
  "Do-What-I-Mean behaviour for a general `keyboard-quit'.

    The generic `keyboard-quit' does not do the expected thing when
    the minibuffer is open.  Whereas we want it to close the
    minibuffer, even without explicitly focusing it.

    The DWIM behaviour of this command is as follows:

    - When the region is active, disable it.
    - When a minibuffer is open, but not focused, close the minibuffer.
    - When the Completions buffer is selected, close it.
    - In every other case use the regular `keyboard-quit'."
  (interactive)
  (cond
   ((region-active-p)
    (keyboard-quit))
   ((derived-mode-p 'completion-list-mode)
    (delete-completion-window))
   ((> (minibuffer-depth) 0)
    (abort-recursive-edit))
   (t
    (keyboard-quit))))

(define-key global-map (kbd "C-g") #'prot/keyboard-quit-dwim)
#+END_SRC
* Dired Settings
:PROPERTIES:
:ID:       0f9bd139-9c70-4884-b866-f1595c35d696
:END:
#+BEGIN_SRC emacs-lisp
;;; dired settings
(use-package dired
  :straight nil
  :commands (dired)
  :hook
  ((dired-mode . dired-hide-details-mode)
   (dired-mode . hl-line-mode))
  :config
  (setq dired-recursive-copies 'always)
  (setq dired-recursive-deletes 'always)
  (setq delete-by-moving-to-trash t)
  (setq dired-listing-switches "-AGFhlv --group-directories-first --time-style=long-iso")
  (setq dired-dwim-target t))

(use-package dired-subtree
  :after dired
  :bind
  ( :map dired-mode-map
    ("<tab>" . dired-subtree-toggle)
    ("TAB" . dired-subtree-toggle)
    ("<backtab>" . dired-subtree-remove)
    ("S-TAB" . dired-subtree-remove))
  :config
  (setq dired-subtree-use-backgrounds nil))

(use-package trashed
  :commands (trashed)
  :config
  (setq trashed-action-confirmer 'y-or-n-p)
  (setq trashed-use-header-line t)
  (setq trashed-sort-key '("Date deleted" . t))
  (setq trashed-date-format "%Y-%m-%d %H:%M:%S"))

(use-package dired-preview
  :after dired
  :config
  (setq dired-preview-delay 0.7)
  (setq dired-preview-max-size (expt 2 25))
  (setq dired-preview-ignored-extensions-regexp
        (concat "\\."
                "\\(gz\\|"
                "zst\\|"
                "tar\\|"
                "xz\\|"
                "rar\\|"
                "zip\\|"
                "iso\\|"
                "RAF\\|"
                "epub"
                "\\)"))

  (dired-preview-global-mode 1))
#+END_SRC
* Bibliography
:PROPERTIES:
:ID:       c3a111f7-4aea-447b-b80e-0564428cac39
:END:
#+begin_src emacs-lisp
(use-package bibtex
  :custom
  (bibtex-user-optional-fields
   '(("keywords" "Keywords to describe the entry" "")
     ("file"     "Relative or absolute path to attachments" "" )))
  (bibtex-align-at-equal-sign t)
  :config
  (ews-bibtex-register)
  :bind
  (("C-c b r" . ews-bibtex-register)))

;; Biblio package for adding BibTeX records

(use-package biblio
  :bind
  (("C-c b b" . ews-bibtex-biblio-lookup)))

;; Citar to access bibliographies

(use-package citar
  :defer t
  :custom
  (citar-bibliography ews-bibtex-files))
#+end_src
* Denote
:PROPERTIES:
:ID:       4bd65ca9-e7c9-4e2a-afb0-f43fcdff58db
:END:
#+BEGIN_SRC emacs-lisp
  ;;; Denote
(use-package denote
  :custom
  (denote-sort-keywords t)
  (denote-link-description-function #'ews-denote-link-description-title-case)
  :hook
  (dired-mode . denote-dired-mode)
  :custom-face
  (denote-faces-link ((t (:slant italic))))
  :bind
  (("C-c n n" . denote)
   ("C-c n r" . denote-rename-file)
   ("C-c n l" . denote-link)
   ("C-c n b" . denote-backlinks)
   ("C-c n d" . denote-dired))
  :config
  (setq denote-directory (expand-file-name "~/Documents/notes/"))
  (denote-rename-buffer-mode 1)
  (setq denote-prompts '(title keywords signature))
  (setq denote-infer-keywords t)
  (setq denote-sort-keywords t)
  (setq denote-file-type 'org))

(use-package denote-org
  :bind
  (("C-c n o h" . denote-org-link-to-heading)
   ("C-c n o s" . denote-org-extract-subtree)))

(use-package denote-markdown)

;; Consult-Notes for easy access to notes

(use-package consult-notes
  :custom
  (consult-notes-denote-display-keywords-indicator "_")
  :bind
  (("C-c d f" . consult-notes)
   ("C-c d g" . consult-notes-search-in-all-notes))
  :init
  (consult-notes-denote-mode))

(use-package consult-denote
  :bind
  (("C-c n f" . consult-denote-find)
   ("C-c n g" . consult-denote-grep))
  :config
  (consult-denote-mode 1))

(use-package denote-sequence
  :bind
  ( :map global-map
    ;; Here we make "C-c n s" a prefix for all "[n]otes with [s]equence".
    ;; This is just for demonstration purposes: use the key bindings
    ;; that work for you.  Also check the commands:
    ;;
    ;; - `denote-sequence-new-parent'
    ;; - `denote-sequence-new-sibling'
    ;; - `denote-sequence-new-child'
    ;; - `denote-sequence-new-child-of-current'
    ;; - `denote-sequence-new-sibling-of-current'
    ("C-c n s s" . denote-sequence)
    ("C-c n s f" . denote-sequence-find)
    ("C-c n s l" . denote-sequence-link)
    ("C-c n s d" . denote-sequence-dired)
    ("C-c n s r" . denote-sequence-reparent)
    ("C-c n s c" . denote-sequence-convert)))

;; Citar-Denote to manage literature notes

(use-package citar-denote
  :custom
  (citar-bibliography '("~/Documents/library/all.bib"))
  (citar-open-always-create-notes t)
  :init
  (citar-denote-mode)
  :bind
  (("C-c n c c" . citar-create-note)
   ("C-c n c n" . citar-denote-open-note)
   ("C-c n c x" . citar-denote-nocite)
   :map org-mode-map
   ("C-c n c k" . citar-denote-add-citekey)
   ("C-c n c K" . citar-denote-remove-citekey)
   ("C-c n c d" . citar-denote-dwim)
   ("C-c n c e" . citar-denote-open-reference-entry)))
#+END_SRC
* Content
:PROPERTIES:
:ID:       9d403f26-82f2-41f3-8c87-96815460a012
:END:
#+BEGIN_SRC emacs-lisp
;;; content
;; Distraction-free writing

(use-package olivetti
  :demand t
  :bind
  (("C-c o" . ews-olivetti)))

;; ediff
(use-package ediff
  :straight nil
  :custom
  (ediff-keep-variants nil)
  (ediff-split-window-function 'split-window-horizontally)
  (ediff-window-setup-function 'ediff-setup-windows-plain))

;; Doc-View
(use-package doc-view
  :custom
  (doc-view-resolution 300)
  (large-file-warning-threshold (* 50 (expt 2 20))))

;;;; PDF Tools
(use-package pdf-tools
  :mode ("\\.pdf\\'" . pdf-view-mode)
  :magic ("%PDF" . pdf-view-mode)
  :init
  ;; Point to the manually compiled server
  (setq pdf-info-epdfinfo-program
        (expand-file-name "straight/repos/pdf-tools/server/epdfinfo"
                          user-emacs-directory))
  :config
  ;; Load pdf-tools
  (pdf-loader-install)

  ;; Display settings
  (setq-default pdf-view-display-size 'fit-page)
  (setq pdf-view-resize-factor 1.1)  ; Zoom increment

  ;; Annotation settings
  (setq pdf-annot-activate-created-annotations t)

  ;; Keybindings for common tasks
  :bind (:map pdf-view-mode-map
              ;; Annotations
              ("C-c C-a h" . pdf-annot-add-highlight-markup-annotation)
              ("C-c C-a t" . pdf-annot-add-text-annotation)
              ("C-c C-a d" . pdf-annot-delete)
              ("C-c C-a l" . pdf-annot-list-annotations)
              ;; Navigation
              ("M-g g" . pdf-view-goto-page)))

;; Read ePub files
(use-package nov
  :init
  (add-to-list 'auto-mode-alist '("\\.epub\\'" . nov-mode)))

;; Read RSS feeds with Elfeed

(use-package elfeed
  :custom
  (elfeed-db-directory
   (expand-file-name "elfeed" user-emacs-directory))
  (elfeed-show-entry-switch 'display-buffer)
  :bind
  ("C-c w e" . elfeed))

(provide 'init)
#+END_SRC
